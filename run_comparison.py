import matplotlib
# 强制使用非交互式后端
matplotlib.use('Agg')

import os
import sys
import random
import networkx as nx
import time
from utils.plotting import plot_graph

try:
    from generate import simple_diagram
except ImportError:
    print("错误：找不到 generate.py。请确保脚本在项目根目录下。")
    sys.exit(1)

def create_baseline_case():
    """
    Baseline: 简单的5节点系统 (用于对比的基准)
    """
    G = nx.Graph()
    nodes = ['1', '2', '3', '4', '5']
    
    for i in nodes:
        G.add_node(i, 
                   x=random.uniform(0, 10),
                   y=random.uniform(0, 10),
                   type='substation' if i == '1' else 'load',
                   name=f"Bus-{i}"
        )
    
    # 简单的链式结构
    edges = [('1', '2'), ('2', '3'), ('3', '4'), ('4', '5')]
    G.add_edges_from(edges)
    
    return G

def create_case1():
    """
    Case 1: 20节点系统 (3个环 + 2个链 + 2个负载)
    """
    G = nx.Graph()
    
    # 节点数据: ID, 名称, x, y, 电压等级
    nodes_data = {
        '1': ("Hub", 512, 487, 500),
        '2': ("K1a", 638, 412, 220),
        '3': ("K1b", 721, 389, 220),
        '4': ("K1c", 693, 573, 220),
        '5': ("K1d", 614, 621, 220),
        '6': ("K2a", 364, 423, 220),
        '7': ("K2b", 287, 391, 220),
        '8': ("K2c", 311, 596, 220),
        '9': ("K2d", 403, 582, 220),
        '10': ("K3a", 571, 338, 220),
        '11': ("K3b", 623, 261, 220),
        '12': ("K3c", 442, 351, 220),
        '13': ("K3d", 387, 273, 220),
        '14': ("C1a", 553, 673, 220),
        '15': ("C1b", 578, 748, 220),
        '16': ("C1c", 531, 832, 220),
        '17': ("C2a", 447, 691, 220),
        '18': ("C2b", 429, 771, 220),
        '19': ("L1", 793, 362, 220),
        '20': ("L2", 208, 413, 220)
    }
    
    # 添加节点
    for node_id, (name, x, y, voltage) in nodes_data.items():
        G.add_node(node_id,
                   x=x,
                   y=y,
                   type='substation' if voltage == 500 else 'load',
                   name=name,
                   voltage=voltage)
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
    
    # 边连接关系
    edges = [
        # 环K1: 1-2-3-4-5-1
        ('1', '2'), ('2', '3'), ('3', '4'), ('4', '5'), ('5', '1'),
        # 环K2: 1-6-7-8-9-1
        ('1', '6'), ('6', '7'), ('7', '8'), ('8', '9'), ('9', '1'),
        # 环K3: 1-10-11-12-13-1
        ('1', '10'), ('10', '11'), ('11', '12'), ('12', '13'), ('13', '1'),
        # 链C1: 1-14-15-16
        ('1', '14'), ('14', '15'), ('15', '16'),
        # 链C2: 1-17-18
        ('1', '17'), ('17', '18'),
        # 负载L1, L2
        ('3', '19'), ('7', '20')
    ]
    G.add_edges_from(edges)
    
    return G

def create_case2():
    """
    Case 2: 中等复杂系统 (20节点，多环结构)
    """
    G = nx.Graph()
    
    # 节点数据: ID, 名称, 坐标, 电压等级
    nodes_data = {
        '1': ("Center", 506, 500, 500),
        '2': ("Inner1", 697, 526, 220),
        '3': ("Inner2", 421, 666, 220),
        '4': ("Inner3", 354, 534, 220),
        '5': ("Inner4", 196, 475, 220),
        '6': ("Inner5", 446, 450, 220),
        '7': ("Outer1a", 550, 700, 220),
        '8': ("Outer1b", 460, 620, 220),
        '9': ("Outer2a", 495, 861, 220),
        '10': ("Outer2b", 365, 855, 220),
        '11': ("Outer3a", 381, 395, 220),
        '12': ("Outer3b", 236, 431, 220),
        '13': ("A1", 592, 267, 220),
        '14': ("A2", 622, 355, 220),
        '15': ("A3", 568, 212, 220),
        '16': ("A4", 447, 330, 220),
        '17': ("B1", 660, 475, 220),
        '18': ("B2", 775, 483, 220),
        '19': ("B3", 796, 539, 220),
        '20': ("B4", 639, 540, 220)
    }
    
    # 添加节点（y坐标取负，使图片下方对应更大的原始y值）
    for node_id, (name, x, y, voltage) in nodes_data.items():
        G.add_node(node_id,
                   x=x,  # 不缩放坐标，保持原始值
                   y=y,  # y取负，翻转坐标系
                   type='substation' if voltage == 500 else 'load',
                   name=name,
                   voltage=voltage)
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
    
    # 连接关系
    edges = [
        ('1', '2'), ('1', '3'), ('1', '4'), ('1', '5'), ('1', '6'),
        ('2', '7'), ('7', '8'), ('1', '8'), ('8', '9'), ('9', '10'), ('10', '3'),
        ('4', '11'), ('11', '12'), ('12', '5'),
        ('1', '16'), ('16', '15'), ('15', '13'), ('13', '14'), ('14', '1'),
        ('17', '18'), ('18', '19'), ('19', '20'), ('20', '1'), ('1', '17')
    ]
    
    G.add_edges_from(edges)
    
    return G

def create_case3():
    """
    Case 3: 20节点系统 (1个带分支环 + 1个环 + 1个环 + 1个链 + 3个负载)
    """
    G = nx.Graph()
    
    # 节点数据: ID, 名称, x, y, 电压等级
    nodes_data = {
        '1': ("Hub", 500, 510, 500),
        '2': ("R1a", 646, 341, 220),
        '3': ("R1b", 655, 372, 220),
        '4': ("R1c", 623, 568, 220),
        '5': ("R1d", 611, 594, 220),
        '6': ("R1s", 642, 478, 220),
        '7': ("K1a", 430, 321, 220),
        '8': ("K1b", 298, 381, 220),
        '9': ("K1c", 339, 586, 220),
        '10': ("K1d", 386, 648, 220),
        '11': ("K2a", 589, 657, 220),
        '12': ("K2b", 650, 701, 220),
        '13': ("K2c", 472, 714, 220),
        '14': ("K2d", 401, 744, 220),
        '15': ("C1a", 605, 356, 220),
        '16': ("C1b", 611, 217, 220),
        '17': ("C1c", 497, 121, 220),
        '18': ("L1", 759, 311, 220),
        '19': ("L2", 249, 349, 220),
        '20': ("L3", 493, 791, 220)
    }
    
    # 添加节点
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id,
                   x=x,
                   y=y,
                   type='substation' if voltage == 500 else 'load',
                   name=name,
                   voltage=voltage)
    
    # 边连接关系
    edges = [
        # 带分支的环R1: 1-2-3-6-1, 6-4-5-1
        ('1', '2'), ('2', '3'), ('3', '6'), ('6', '1'), ('6', '4'), ('4', '5'), ('5', '1'),
        # 环K1: 1-7-8-9-10-1
        ('1', '7'), ('7', '8'), ('8', '9'), ('9', '10'), ('10', '1'),
        # 环K2: 1-11-12-13-14-1
        ('1', '11'), ('11', '12'), ('12', '13'), ('13', '14'), ('14', '1'),
        # 链C1: 1-15-16-17
        ('1', '15'), ('15', '16'), ('16', '17'),
        # 负载L1, L2, L3
        ('3', '18'), ('8', '19'), ('12', '20')
    ]
    
    G.add_edges_from(edges)
    
    return G

def create_case4():
    """
    Case 4: 22节点系统 (4个环 + 5个负载)
    """
    G = nx.Graph()
    
    # 节点数据: ID, 名称, x, y, 电压等级
    nodes_data = {
        '1': ("Hub", 485, 499, 500),
        '2': ("E1", 629, 471, 220),
        '3': ("E2", 649, 475, 220),
        '4': ("E3", 669, 574, 220),
        '5': ("E4", 650, 634, 220),
        '6': ("W1", 400, 436, 220),
        '7': ("W2", 258, 417, 220),
        '8': ("W3", 309, 592, 220),
        '9': ("W4", 433, 579, 220),
        '10': ("N1", 566, 326, 220),
        '11': ("N2", 556, 320, 220),
        '12': ("N3", 514, 415, 220),
        '13': ("N4", 410, 260, 220),
        '14': ("S1", 560, 682, 220),
        '15': ("S2", 624, 739, 220),
        '16': ("S3", 436, 619, 220),
        '17': ("S4", 446, 692, 220),
        '18': ("LE1", 743, 341, 220),
        '19': ("LW1", 172, 446, 220),
        '20': ("LN1", 446, 201, 220),
        '21': ("LS1", 482, 812, 220),
        '22': ("LE2", 723, 601, 220)
    }
    
    # 添加节点
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id,
                   x=x,
                   y=y,
                   type='substation' if voltage == 500 else 'load',
                   name=name,
                   voltage=voltage)
    
    # 边连接关系
    edges = [
        # 环E: 1-2-3-4-5-1
        ('1', '2'), ('2', '3'), ('3', '4'), ('4', '5'), ('5', '1'),
        # 环W: 1-6-7-8-9-1
        ('1', '6'), ('6', '7'), ('7', '8'), ('8', '9'), ('9', '1'),
        # 环N: 1-10-11-12-13-1
        ('1', '10'), ('10', '11'), ('11', '12'), ('12', '13'), ('13', '1'),
        # 环S: 1-14-15-16-17-1
        ('1', '14'), ('14', '15'), ('15', '16'), ('16', '17'), ('17', '1'),
        # 负载
        ('3', '18'), ('7', '19'), ('11', '20'), ('15', '21'), ('4', '22')
    ]
    
    G.add_edges_from(edges)
    
    return G

def create_case5():
    """
    Case 5: 16节点系统 (2个环 + 2个链 + 2个负载)
    Ring A: Hub-A1-A2-A3-A4-A5-Hub (with diagonal 1-4)
    Ring B: Hub-B1-B2-B3-Hub
    Chain C: Hub-C1-C2-C3
    Chain D: Hub-D1-D2
    Loads: L1, L2
    """
    G = nx.Graph()
    
    # 节点数据: ID, 名称, x, y, 电压等级
    nodes_data = {
        '1': ("Hub", 491, 502, 500),
        '2': ("A1", 627, 378, 220),
        '3': ("A2", 738, 342, 220),
        '4': ("A3", 782, 467, 220),
        '5': ("A4", 718, 558, 220),
        '6': ("A5", 598, 572, 220),
        '7': ("B1", 391, 612, 220),
        '8': ("B2", 318, 698, 220),
        '9': ("B3", 398, 752, 220),
        '10': ("C1", 378, 381, 220),
        '11': ("C2", 298, 308, 220),
        '12': ("C3", 231, 247, 220),
        '13': ("D1", 548, 648, 220),
        '14': ("D2", 587, 738, 220),
        '15': ("L1", 838, 318, 220),
        '16': ("L2", 247, 768, 220)
    }
    
    # 添加节点
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id,
                   x=x,
                   y=y,
                   type='substation' if voltage == 500 else 'load',
                   name=name,
                   voltage=voltage)
    
    # 边连接关系
    edges = [
        # 环A: Hub-A1-A2-A3-A4-A5-Hub
        ('1', '2'), ('2', '3'), ('3', '4'), ('4', '5'), ('5', '6'), ('6', '1'),
        # 环A对角线
        ('1', '4'),
        # 环B: Hub-B1-B2-B3-Hub
        ('1', '7'), ('7', '8'), ('8', '9'), ('9', '1'),
        # 链C: Hub-C1-C2-C3
        ('1', '10'), ('10', '11'), ('11', '12'),
        # 链D: Hub-D1-D2
        ('1', '13'), ('13', '14'),
        # 负载
        ('3', '15'), ('8', '16')
    ]
    
    G.add_edges_from(edges)
    
    return G

def create_case6():
    """
    Case 6: 22节点系统 (2个复杂环 + 2个环 + 1个链 + 3个负载)
    Ring A: Hub-A1-A2-AS-Hub + AS-A4-A5-A6-Hub + A3-A4 + A5-AS (two triangles sharing AS)
    Ring B: Hub-B1-B2-B3-B4-Hub
    Ring C: Hub-C1-C2-C3-C4-Hub
    Chain D: Hub-D1-D2-D3
    Loads: L1, L2, L3
    """
    G = nx.Graph()
    
    # 节点数据: ID, 名称, x, y, 电压等级
    nodes_data = {
        '1': ("Hub", 521, 483, 500),
        '2': ("A1", 628, 371, 220),
        '3': ("A2", 582, 258, 220),
        '4': ("A3", 723, 293, 220),
        '5': ("A4", 768, 417, 220),
        '6': ("A5", 712, 531, 220),
        '7': ("A6", 618, 568, 220),
        '8': ("AS", 672, 413, 220),
        '9': ("B1", 397, 611, 220),
        '10': ("B2", 318, 713, 220),
        '11': ("B3", 382, 798, 220),
        '12': ("B4", 478, 738, 220),
        '13': ("C1", 373, 378, 220),
        '14': ("C2", 281, 312, 220),
        '15': ("C3", 312, 228, 220),
        '16': ("C4", 418, 271, 220),
        '17': ("D1", 548, 648, 220),
        '18': ("D2", 587, 742, 220),
        '19': ("D3", 531, 831, 220),
        '20': ("L1", 827, 278, 220),
        '21': ("L2", 238, 753, 220),
        '22': ("L3", 463, 168, 220)
    }
    
    # 添加节点
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id,
                   x=x,
                   y=y,
                   type='substation' if voltage == 500 else 'load',
                   name=name,
                   voltage=voltage)
    
    # 边连接关系
    edges = [
        # 复杂环A: Hub-A1-A2-AS-Hub, AS-A3-A4-A5-A6-Hub, A5-AS
        ('1', '2'), ('2', '3'), ('3', '8'), ('8', '1'),
        ('8', '4'), ('4', '5'), ('5', '6'), ('6', '7'), ('7', '1'),
        ('5', '8'),
        # 环B: Hub-B1-B2-B3-B4-Hub
        ('1', '9'), ('9', '10'), ('10', '11'), ('11', '12'), ('12', '1'),
        # 环C: Hub-C1-C2-C3-C4-Hub
        ('1', '13'), ('13', '14'), ('14', '15'), ('15', '16'), ('16', '1'),
        # 链D: Hub-D1-D2-D3
        ('1', '17'), ('17', '18'), ('18', '19'),
        # 负载
        ('4', '20'), ('10', '21'), ('15', '22')
    ]
    
    G.add_edges_from(edges)
    
    return G

def create_case7():
    """
    Case 7: 21节点系统 (3个双三角环 + 1个链 + 2个负载)
    Ring R1: Hub-R1a-R1b-R1s-Hub + R1s-R1c-R1d-Hub (sharing R1s)
    Ring R2: Hub-R2a-R2b-R2s-Hub + R2s-R2c-R2d-Hub (sharing R2s)
    Ring R3: Hub-R3a-R3b-R3s-Hub + R3s-R3c-R3d-Hub (sharing R3s)
    Chain C1: Hub-C1a-C1b-C1c
    Loads: L1, L2
    """
    G = nx.Graph()
    
    # 节点数据: ID, 名称, x, y, 电压等级
    nodes_data = {
        '1': ("Hub", 493, 493, 500),
        '2': ("R1a", 557, 359, 220),
        '3': ("R1b", 737, 433, 220),
        '4': ("R1c", 679, 471, 220),
        '5': ("R1d", 561, 502, 220),
        '6': ("R1s", 604, 482, 220),
        '7': ("R2a", 399, 422, 220),
        '8': ("R2b", 292, 433, 220),
        '9': ("R2c", 322, 548, 220),
        '10': ("R2d", 403, 610, 220),
        '11': ("R2s", 327, 425, 220),
        '12': ("R3a", 535, 697, 220),
        '13': ("R3b", 645, 702, 220),
        '14': ("R3c", 583, 771, 220),
        '15': ("R3d", 510, 626, 220),
        '16': ("R3s", 553, 662, 220),
        '17': ("C1a", 568, 312, 220),
        '18': ("C1b", 502, 263, 220),
        '19': ("C1c", 514, 214, 220),
        '20': ("L1", 805, 314, 220),
        '21': ("L2", 262, 338, 220)
    }
    
    # 添加节点
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id,
                   x=x,
                   y=y,
                   type='substation' if voltage == 500 else 'load',
                   name=name,
                   voltage=voltage)
    
    # 边连接关系
    edges = [
        # 双三角环R1: Hub-R1a-R1b-R1s-Hub + R1s-R1c-R1d-Hub
        ('1', '2'), ('2', '3'), ('3', '6'),
        ('6', '1'), ('6', '4'), ('4', '5'),
        ('5', '1'),
        # 双三角环R2: Hub-R2a-R2b-R2s-Hub + R2s-R2c-R2d-Hub
        ('1', '7'), ('7', '8'), ('8', '11'),
        ('11', '1'), ('11', '9'), ('9', '10'),
        ('10', '1'),
        # 双三角环R3: Hub-R3a-R3b-R3s-Hub + R3s-R3c-R3d-Hub
        ('1', '12'), ('12', '13'), ('13', '16'),
        ('16', '1'), ('16', '14'), ('14', '15'),
        ('15', '1'),
        # 链C1: Hub-C1a-C1b-C1c
        ('1', '17'), ('17', '18'), ('18', '19'),
        # 负载
        ('3', '20'), ('8', '21')
    ]
    
    G.add_edges_from(edges)
    
    return G

def create_case8():
    """
    Case 8: 20节点系统 (2个环 + 3个链 + 2个负载)
    """
    G = nx.Graph()
    
    nodes_data = {
        '1': ("Hub", 513, 485, 500),
        '2': ("K1a", 635, 381, 220),
        '3': ("K1b", 727, 446, 220),
        '4': ("K1c", 673, 594, 220),
        '5': ("K1d", 584, 555, 220),
        '6': ("K2a", 352, 417, 220),
        '7': ("K2b", 298, 363, 220),
        '8': ("K2c", 289, 562, 220),
        '9': ("K2d", 356, 568, 220),
        '10': ("C1a", 540, 306, 220),
        '11': ("C1b", 535, 265, 220),
        '12': ("C1c", 619, 232, 220),
        '13': ("C2a", 472, 327, 220),
        '14': ("C2b", 390, 217, 220),
        '15': ("C2c", 342, 153, 220),
        '16': ("C3a", 547, 631, 220),
        '17': ("C3b", 557, 793, 220),
        '18': ("C3c", 611, 860, 220),
        '19': ("L1", 806, 398, 220),
        '20': ("L2", 255, 381, 220)
    }
    
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id, x=x, y=y, type='substation' if voltage == 500 else 'load', name=name, voltage=voltage)
    
    edges = [
        ('1', '2'), ('2', '3'), ('3', '4'), ('4', '5'), ('5', '1'),
        ('1', '6'), ('6', '7'), ('7', '8'), ('8', '9'), ('9', '1'),
        ('1', '10'), ('10', '11'), ('11', '12'),
        ('1', '13'), ('13', '14'), ('14', '15'),
        ('1', '16'), ('16', '17'), ('17', '18'),
        ('3', '19'), ('7', '20')
    ]
    
    G.add_edges_from(edges)
    return G

def create_case9():
    """
    Case 9: 22节点系统 (8个链)
    """
    G = nx.Graph()
    
    nodes_data = {
        '1': ("Hub", 493, 495, 500),
        '2': ("N1", 545, 430, 220),
        '3': ("N2", 538, 338, 220),
        '4': ("N3", 521, 297, 220),
        '5': ("NE1", 596, 476, 220),
        '6': ("NE2", 701, 403, 220),
        '7': ("NE3", 791, 348, 220),
        '8': ("E1", 597, 577, 220),
        '9': ("E2", 754, 507, 220),
        '10': ("E3", 819, 541, 220),
        '11': ("SE1", 544, 583, 220),
        '12': ("SE2", 656, 685, 220),
        '13': ("S1", 496, 654, 220),
        '14': ("S2", 509, 682, 220),
        '15': ("S3", 515, 778, 220),
        '16': ("SW1", 467, 654, 220),
        '17': ("SW2", 397, 720, 220),
        '18': ("W1", 414, 555, 220),
        '19': ("W2", 316, 490, 220),
        '20': ("W3", 204, 587, 220),
        '21': ("NW1", 376, 428, 220),
        '22': ("NW2", 419, 262, 220)
    }
    
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id, x=x, y=y, type='substation' if voltage == 500 else 'load', name=name, voltage=voltage)
    
    edges = [
        ('1', '2'), ('2', '3'), ('3', '4'),
        ('1', '5'), ('5', '6'), ('6', '7'),
        ('1', '8'), ('8', '9'), ('9', '10'),
        ('1', '11'), ('11', '12'),
        ('1', '13'), ('13', '14'), ('14', '15'),
        ('1', '16'), ('16', '17'),
        ('1', '18'), ('18', '19'), ('19', '20'),
        ('1', '21'), ('21', '22')
    ]
    
    G.add_edges_from(edges)
    return G

def create_case10():
    """
    Case 10: 24节点系统 (1个复杂环 + 1个大环 + 3个链 + 4个负载)
    """
    G = nx.Graph()
    
    nodes_data = {
        '1': ("Hub", 517, 478, 500),
        '2': ("A1", 632, 347, 220),
        '3': ("A2", 718, 298, 220),
        '4': ("A3", 783, 391, 220),
        '5': ("A4", 731, 502, 220),
        '6': ("A5", 641, 538, 220),
        '7': ("AS", 713, 418, 220),
        '8': ("B1", 387, 352, 220),
        '9': ("B2", 293, 278, 220),
        '10': ("B3", 218, 341, 220),
        '11': ("B4", 247, 452, 220),
        '12': ("B5", 318, 528, 220),
        '13': ("B6", 412, 562, 220),
        '14': ("C1", 467, 638, 220),
        '15': ("C2", 413, 731, 220),
        '16': ("C3", 487, 812, 220),
        '17': ("D1", 578, 621, 220),
        '18': ("D2", 647, 718, 220),
        '19': ("E1", 548, 312, 220),
        '20': ("E2", 497, 218, 220),
        '21': ("L1", 847, 321, 220),
        '22': ("L2", 148, 378, 220),
        '23': ("L3", 538, 887, 220),
        '24': ("L4", 721, 778, 220)
    }
    
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id, x=x, y=y, type='substation' if voltage == 500 else 'load', name=name, voltage=voltage)
    
    edges = [
        ('1', '2'), ('2', '3'), ('3', '7'), ('7', '1'), ('7', '4'), ('4', '5'), ('5', '6'), ('6', '1'), ('4', '7'),
        ('1', '8'), ('8', '9'), ('9', '10'), ('10', '11'), ('11', '12'), ('12', '13'), ('13', '1'),
        ('1', '14'), ('14', '15'), ('15', '16'),
        ('1', '17'), ('17', '18'),
        ('1', '19'), ('19', '20'),
        ('3', '21'), ('10', '22'), ('16', '23'), ('18', '24')
    ]
    
    G.add_edges_from(edges)
    return G

def create_case11():
    """
    Case 11: 22节点系统 (1个环 + 5个链 + 3个负载)
    """
    G = nx.Graph()
    
    nodes_data = {
        '1': ("Hub", 493, 512, 500),
        '2': ("K1a", 621, 418, 220),
        '3': ("K1b", 706, 443, 220),
        '4': ("K1c", 693, 571, 220),
        '5': ("K1d", 618, 587, 220),
        '6': ("C1a", 387, 417, 220),
        '7': ("C1b", 307, 398, 220),
        '8': ("C1c", 231, 381, 220),
        '9': ("C2a", 541, 632, 220),
        '10': ("C2b", 561, 714, 220),
        '11': ("C2c", 537, 798, 220),
        '12': ("C3a", 457, 638, 220),
        '13': ("C3b", 433, 718, 220),
        '14': ("C4a", 538, 337, 220),
        '15': ("C4b", 561, 258, 220),
        '16': ("C4c", 541, 179, 220),
        '17': ("C5a", 458, 341, 220),
        '18': ("C5b", 432, 261, 220),
        '19': ("C5c", 451, 181, 220),
        '20': ("L1", 784, 411, 220),
        '21': ("L2", 153, 367, 220),
        '22': ("L3", 617, 867, 220)
    }
    
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id, x=x, y=y, type='substation' if voltage == 500 else 'load', name=name, voltage=voltage)
    
    edges = [
        ('1', '2'), ('2', '3'), ('3', '4'), ('4', '5'), ('5', '1'),
        ('1', '6'), ('6', '7'), ('7', '8'),
        ('1', '9'), ('9', '10'), ('10', '11'),
        ('1', '12'), ('12', '13'),
        ('1', '14'), ('14', '15'), ('15', '16'),
        ('1', '17'), ('17', '18'), ('18', '19'),
        ('3', '20'), ('8', '21'), ('11', '22')
    ]
    
    G.add_edges_from(edges)
    return G

def create_case12():
    """
    Case 12: 21节点系统 (1个大环 + 1个环 + 4个负载)
    """
    G = nx.Graph()
    
    nodes_data = {
        '1': ("Hub", 508, 503, 500),
        '2': ("C1", 578, 355, 220),
        '3': ("C2", 592, 380, 220),
        '4': ("C3", 638, 320, 220),
        '5': ("C4", 673, 177, 220),
        '6': ("C5", 675, 138, 220),
        '7': ("C6", 676, 147, 220),
        '8': ("C7", 514, 115, 220),
        '9': ("C8", 494, 158, 220),
        '10': ("C9", 402, 245, 220),
        '11': ("C10", 460, 260, 220),
        '12': ("C11", 461, 390, 220),
        '13': ("C12", 509, 441, 220),
        '14': ("K1a", 604, 650, 220),
        '15': ("K1b", 625, 645, 220),
        '16': ("K1c", 432, 609, 220),
        '17': ("K1d", 430, 706, 220),
        '18': ("L1", 641, 157, 220),
        '19': ("L2", 370, 130, 220),
        '20': ("L3", 667, 749, 220),
        '21': ("L4", 383, 757, 220)
    }
    
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id, x=x, y=y, type='substation' if voltage == 500 else 'load', name=name, voltage=voltage)
    
    edges = [
        ('1', '2'), ('2', '3'), ('3', '4'), ('4', '5'), ('5', '6'), ('6', '7'), ('7', '8'), ('8', '9'), ('9', '10'), ('10', '11'), ('11', '12'), ('12', '13'), ('13', '1'),
        ('1', '14'), ('14', '15'), ('15', '16'), ('16', '17'), ('17', '1'),
        ('5', '18'), ('9', '19'), ('15', '20'), ('17', '21')
    ]
    
    G.add_edges_from(edges)
    return G

def create_case13():
    """
    Case 13: 13节点系统 (3个双三角环 + 2个负载)
    """
    G = nx.Graph()
    
    nodes_data = {
        '1': ("Hub", 503, 491, 500),
        '2': ("A1", 621, 387, 220),
        '3': ("A2", 587, 298, 220),
        '4': ("A3", 712, 321, 220),
        '5': ("A4", 738, 428, 220),
        '6': ("B1", 408, 371, 220),
        '7': ("B2", 327, 298, 220),
        '8': ("B3", 248, 367, 220),
        '9': ("B4", 278, 468, 220),
        '10': ("C1", 612, 638, 220),
        '11': ("C2", 698, 621, 220),
        '12': ("L1", 798, 287, 220),
        '13': ("L2", 178, 398, 220)
    }
    
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id, x=x, y=y, type='substation' if voltage == 500 else 'load', name=name, voltage=voltage)
    
    edges = [
        ('1', '2'), ('2', '3'), ('3', '1'), ('3', '4'), ('4', '5'), ('5', '1'),
        ('1', '6'), ('6', '7'), ('7', '1'), ('7', '8'), ('8', '9'), ('9', '1'),
        ('1', '10'), ('10', '11'), ('11', '1'),
        ('4', '12'), ('8', '13')
    ]
    
    G.add_edges_from(edges)
    return G

def create_case14():
    """
    Case 14: 16节点系统 (2个复杂环 + 1个链 + 3个负载)
    """
    G = nx.Graph()
    
    nodes_data = {
        '1': ("Hub", 498, 508, 500),
        '2': ("A1", 651, 467, 220),
        '3': ("A2", 687, 341, 220),
        '4': ("A3", 791, 512, 220),
        '5': ("A4", 672, 571, 220),
        '6': ("A5", 762, 647, 220),
        '7': ("B1", 371, 431, 220),
        '8': ("B2", 342, 298, 220),
        '9': ("B3", 218, 451, 220),
        '10': ("B4", 327, 561, 220),
        '11': ("B5", 198, 612, 220),
        '12': ("C1", 567, 667, 220),
        '13': ("C2", 612, 762, 220),
        '14': ("L1", 397, 287, 220),
        '15': ("L2", 582, 312, 220),
        '16': ("L3", 638, 641, 220)
    }
    
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id, x=x, y=y, type='substation' if voltage == 500 else 'load', name=name, voltage=voltage)
    
    edges = [
        ('1', '2'), ('2', '3'), ('3', '4'), ('4', '5'), ('5', '1'), ('5', '6'), ('6', '1'),
        ('1', '7'), ('7', '8'), ('8', '9'), ('9', '10'), ('10', '1'), ('10', '11'), ('11', '1'),
        ('1', '12'), ('12', '13'),
        ('1', '14'), ('1', '15'), ('5', '16')
    ]
    
    G.add_edges_from(edges)
    return G

def create_case15():
    """
    Case 15: 23节点系统 (2个复杂双三角环 + 1个大环 + 1个链)
    """
    G = nx.Graph()
    
    nodes_data = {
        '1': ("Hub", 493, 509, 500),
        '2': ("A1", 664, 378, 220),
        '3': ("A2", 727, 420, 220),
        '4': ("A3", 739, 539, 220),
        '5': ("A4", 707, 583, 220),
        '6': ("A5", 624, 558, 220),
        '7': ("AS", 666, 507, 220),
        '8': ("B1", 427, 305, 220),
        '9': ("B2", 357, 398, 220),
        '10': ("B3", 227, 499, 220),
        '11': ("B4", 264, 604, 220),
        '12': ("B5", 452, 561, 220),
        '13': ("BS", 322, 484, 220),
        '14': ("C1", 522, 644, 220),
        '15': ("C2", 542, 676, 220),
        '16': ("C3", 462, 758, 220),
        '17': ("C4", 436, 728, 220),
        '18': ("C5", 465, 593, 220),
        '19': ("D1", 506, 283, 220),
        '20': ("D2", 585, 215, 220),
        '21': ("D3", 529, 108, 220),
        '22': ("D4", 398, 245, 220),
        '23': ("D5", 404, 240, 220)
    }
    
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id, x=x, y=y, type='substation' if voltage == 500 else 'load', name=name, voltage=voltage)
    
    edges = [
        ('1', '2'), ('2', '3'), ('3', '7'), ('7', '1'), ('7', '4'), ('4', '5'), ('5', '7'), ('5', '6'), ('6', '1'),
        ('1', '8'), ('8', '9'), ('9', '13'), ('13', '1'), ('13', '10'), ('10', '11'), ('11', '13'), ('11', '12'), ('12', '1'),
        ('1', '14'), ('14', '15'), ('15', '16'), ('16', '17'), ('17', '18'), ('18', '1'),
        ('1', '19'), ('19', '20'), ('20', '21'), ('21', '22'), ('22', '23'), ('23', '1')
    ]
    
    G.add_edges_from(edges)
    return G

def create_case16():
    """
    Case 16: 16节点系统 (2个复杂环 + 1个链 + 3个负载)
    """
    G = nx.Graph()
    
    nodes_data = {
        '1': ("Hub", 491, 487, 500),
        '2': ("A1", 378, 398, 220),
        '3': ("A2", 312, 327, 220),
        '4': ("A3", 387, 542, 220),
        '5': ("B1", 298, 778, 220),
        '6': ("B2", 58, 738, 220),
        '7': ("B3", 52, 378, 220),
        '8': ("C1", 612, 418, 220),
        '9': ("C2", 718, 368, 220),
        '10': ("C3", 748, 478, 220),
        '11': ("C4", 668, 548, 220),
        '12': ("D1", 448, 638, 220),
        '13': ("D2", 418, 718, 220),
        '14': ("L1", 548, 328, 220),
        '15': ("L2", 478, 638, 220),
        '16': ("L3", 321, 238, 220)
    }
    
    for node_id, (name, x, y, voltage) in nodes_data.items():
        print(f"添加节点 {node_id}: {name} ({x}, {y}), 电压等级: {voltage}")
        G.add_node(node_id, x=x, y=y, type='substation' if voltage == 500 else 'load', name=name, voltage=voltage)
    
    edges = [
        ('1', '2'), ('2', '3'), ('3', '4'), ('4', '1'), ('4', '5'), ('5', '6'), ('6', '7'), ('7', '1'),
        ('1', '8'), ('8', '9'), ('9', '10'), ('10', '11'), ('11', '1'),
        ('1', '12'), ('12', '13'),
        ('1', '14'), ('1', '15'), ('3', '16')
    ]
    
    G.add_edges_from(edges)
    return G

def run_comparison_experiment():
    """
    运行对比实验，生成baseline和三个case的结果
    """
    # 设置随机种子以确保可重复性
    random.seed(42)
    
    cases = {
        'baseline': (create_baseline_case, 'Baseline_5_Nodes_Simple'),
        'case1': (create_case1, 'Case1_20_Nodes_3Ring2Chain'),
        'case2': (create_case2, 'Case2_20_Nodes_MultiRing'),
        'case3': (create_case3, 'Case3_20_Nodes_BranchRing'),
        'case4': (create_case4, 'Case4_22_Nodes_4Ring5Load'),
        'case5': (create_case5, 'Case5_16_Nodes_2Ring2Chain'),
        'case6': (create_case6, 'Case6_22_Nodes_ComplexRing'),
        'case7': (create_case7, 'Case7_21_Nodes_3DoubleTriangle'),
        'case8': (create_case8, 'Case8_20_Nodes_2Ring3Chain'),
        'case9': (create_case9, 'Case9_22_Nodes_8Chain'),
        'case10': (create_case10, 'Case10_24_Nodes_ComplexRing'),
        'case11': (create_case11, 'Case11_22_Nodes_1Ring5Chain'),
        'case12': (create_case12, 'Case12_21_Nodes_BigRing'),
        'case13': (create_case13, 'Case13_13_Nodes_3DoubleTriangle'),
        'case14': (create_case14, 'Case14_16_Nodes_2ComplexRing'),
        'case15': (create_case15, 'Case15_23_Nodes_2DoubleTriRing'),
        'case16': (create_case16, 'Case16_16_Nodes_2ComplexRing')
    }
    
    results = {}
    
    for case_id, (create_func, case_name) in cases.items():
        print("\n" + "="*60)
        print(f"运行 {case_name}")
        print("="*60)
        
        # 创建输出目录
        output_dir = f'output_comparison/{case_id}'
        if not os.path.exists(output_dir):
            os.makedirs(output_dir)
        
        # 生成图数据
        graph = create_func()
        print(f"图数据构造完成: 节点数={graph.number_of_nodes()}, 边数={graph.number_of_edges()}")
        

        # 运行优化
        try:
            start_time = time.time()
            simple_diagram(
                graph=graph,
                graph_name=case_name,
                max_layout_retry=10,
                save_diagram=True,
                save_dir=output_dir,
                seed=42
            )
            total_time = time.time() - start_time
            
            results[case_id] = {
                'name': case_name,
                'nodes': graph.number_of_nodes(),
                'edges': graph.number_of_edges(),
                'time': total_time,
                'status': 'success'
            }
            
            print(f"✓ {case_name} 完成！总时间: {total_time:.2f}s")
            print(f"  结果保存在: {os.path.abspath(output_dir)}")
            
        except Exception as e:
            print(f"✗ {case_name} 运行失败！")
            print(f"  错误信息: {e}")
            import traceback
            traceback.print_exc()
            
            results[case_id] = {
                'name': case_name,
                'nodes': graph.number_of_nodes(),
                'edges': graph.number_of_edges(),
                'time': 0,
                'status': 'failed',
                'error': str(e)
            }
    
    # 打印总结报告
    print("\n" + "="*60)
    print("对比实验总结")
    print("="*60)
    print(f"{'Case':<15} {'节点数':<8} {'边数':<8} {'时间(s)':<10} {'状态':<10}")
    print("-"*60)
    
    for case_id in ['case3']:
        r = results[case_id]
        print(f"{case_id:<15} {r['nodes']:<8} {r['edges']:<8} {r['time']:<10.2f} {r['status']:<10}")
    
    print("="*60)
    print(f"\n所有结果保存在: {os.path.abspath('output_comparison')}")
    print("每个case包含: raw.pdf (原始), cross.pdf (交叉优化), layout.pdf (最终布局)")
    
    return results

def main():
    print("开始运行论文对比实验...")
    print("将生成: Baseline + 3个对比Case")
    print()
    
    results = run_comparison_experiment()
    
    print("\n实验完成！")
    print("你现在可以使用这些图表进行论文对比分析。")

if __name__ == "__main__":
    main()
